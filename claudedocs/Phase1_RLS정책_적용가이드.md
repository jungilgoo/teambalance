# Phase 1 Day 2-3: Supabase RLS 정책 적용 가이드

**작업일**: 2025-01-03  
**단계**: Phase 1 - 보안 Critical 이슈 해결  
**목표**: 모든 테이블에 Row Level Security 활성화 및 사용자별 접근 정책 구현

---

## 📋 생성된 파일

### 1. 핵심 RLS 정책 스크립트 ✅
**파일**: `sql/phase1-rls-policies.sql`
- **크기**: 약 300줄의 종합적 RLS 정책
- **적용 범위**: 7개 주요 테이블 (profiles, teams, team_members, team_invites, sessions, matches, match_members)
- **보안 수준**: 사용자별/팀별 엄격한 접근 제어

### 2. RLS 정책 테스트 스크립트 ✅
**파일**: `sql/phase1-rls-test.sql`
- **목적**: RLS 정책이 올바르게 적용되었는지 검증
- **기능**: 정책 상태 확인, 보안 이슈 탐지, 성공 기준 체크

### 3. 롤백 스크립트 (비상용) ✅
**파일**: `sql/phase1-rls-rollback.sql`
- **목적**: 문제 발생 시 안전하게 RLS 정책 제거
- **⚠️ 주의**: 개발 환경에서만 사용, 프로덕션 금지

---

## 🛡️ RLS 보안 정책 설계

### 핵심 보안 원칙
1. **사용자 중심 접근 제어**: 모든 정책이 `auth.uid()` 기반
2. **팀 기반 권한 분리**: 팀 멤버만 팀 데이터 접근 가능
3. **역할 기반 권한**: 팀 리더 vs 일반 멤버 권한 구분
4. **최소 권한 원칙**: 필요한 최소한의 접근만 허용

### 테이블별 보안 정책

#### 1. **PROFILES** - 개인 정보 보호
- ✅ **조회**: 자신의 프로필만
- ✅ **수정**: 자신의 프로필만  
- ✅ **생성**: 회원가입 시 본인 프로필만
- ✅ **삭제**: 자신의 프로필만

#### 2. **TEAMS** - 팀 정보 보호
- ✅ **조회**: 공개 팀 + 자신이 속한 비공개 팀
- ✅ **생성**: 인증된 사용자 (팀 리더로)
- ✅ **수정**: 팀 리더만
- ✅ **삭제**: 팀 리더만

#### 3. **TEAM_MEMBERS** - 멤버 정보 보호  
- ✅ **조회**: 같은 팀 멤버들만
- ✅ **생성**: 팀 리더 또는 본인 (참가 시)
- ✅ **수정**: 팀 리더 또는 본인
- ✅ **삭제**: 팀 리더 또는 본인 (탈퇴 시)

#### 4. **SESSIONS/MATCHES** - 경기 데이터 보호
- ✅ **조회**: 관련 팀 멤버만
- ✅ **생성**: 팀 멤버만
- ✅ **수정**: 세션 생성자 또는 팀 리더
- ✅ **삭제**: 팀 리더만

---

## 🚀 RLS 정책 적용 단계

### 단계 1: Supabase 콘솔 접속
1. [Supabase 대시보드](https://app.supabase.com) 접속
2. TeamBalance 프로젝트 선택
3. 좌측 메뉴에서 "SQL Editor" 클릭

### 단계 2: RLS 정책 적용
```sql
-- 다음 파일의 내용을 SQL Editor에 복사-붙여넣기
-- 파일 경로: C:\TeamBalance\sql\phase1-rls-policies.sql

-- 또는 파일 업로드 기능 사용:
-- 1. "New query" 클릭
-- 2. 파일 업로드 아이콘 클릭  
-- 3. phase1-rls-policies.sql 파일 선택
-- 4. "Run" 버튼 클릭
```

### 단계 3: 적용 결과 확인
```sql
-- 다음 파일로 정책 적용 상태 검증
-- 파일 경로: C:\TeamBalance\sql\phase1-rls-test.sql

-- 성공 기준:
-- ✅ 모든 테이블 rowsecurity = true
-- ✅ 각 테이블마다 4개 이상의 정책 존재
-- ✅ 보안 이슈 0개
```

### 단계 4: 애플리케이션 테스트
```bash
# 로컬 개발 서버 실행
npm run dev

# 테스트 시나리오:
# 1. 회원가입/로그인 정상 작동 확인
# 2. 팀 생성 및 참가 기능 확인  
# 3. 다른 팀 데이터 접근 차단 확인
# 4. 팀 리더/멤버 권한 구분 확인
```

---

## ⚠️ 문제 발생 시 대응

### 일반적인 문제점

#### 1. **RLS 정책 적용 실패**
```bash
오류 예시: "insufficient privilege" 또는 "permission denied"

해결방법:
1. Supabase 프로젝트 설정 확인
2. 데이터베이스 관리자 권한 확인
3. 테이블 존재 여부 확인
```

#### 2. **애플리케이션 접근 불가**
```bash
증상: 로그인 후 데이터가 로드되지 않음

해결방법:
1. phase1-rls-test.sql로 정책 상태 확인
2. 브라우저 개발자 도구에서 네트워크 에러 확인
3. Supabase 콘솔에서 실제 데이터 존재 확인
```

#### 3. **비상 롤백 필요**
```sql
-- ⚠️ 마지막 수단: 모든 RLS 정책 제거
-- 파일: sql/phase1-rls-rollback.sql
-- 주의: 개발 환경에서만 사용!
```

---

## ✅ 완료 확인 체크리스트

### 기술적 확인사항
- [ ] **모든 테이블 RLS 활성화**: `rowsecurity = true`
- [ ] **정책 개수 확인**: 총 28개 이상의 정책 생성
- [ ] **보안 이슈 0개**: 정책 누락 테이블 없음
- [ ] **익명 접근 차단**: 인증되지 않은 접근 불가

### 기능적 확인사항  
- [ ] **로그인/회원가입 정상 작동**
- [ ] **자신의 팀만 조회 가능**
- [ ] **다른 팀 데이터 접근 차단**
- [ ] **팀 리더/멤버 권한 구분 정상**
- [ ] **세션 생성/경기 진행 정상**

### 성능 확인사항
- [ ] **페이지 로딩 속도 정상** (RLS로 인한 지연 없음)
- [ ] **대용량 데이터 조회 정상** (정책 최적화)
- [ ] **데이터베이스 부하 정상** (인덱스 활용)

---

## 📊 예상 보안 강화 효과

### Before (RLS 적용 전)
- ❌ **모든 사용자가 모든 데이터 접근 가능**
- ❌ **클라이언트 코드만으로 접근 제어**
- ❌ **데이터베이스 레벨 보안 없음**
- ❌ **SQL Injection 시 전체 데이터 노출**

### After (RLS 적용 후)  
- ✅ **데이터베이스 레벨에서 엄격한 접근 제어**
- ✅ **사용자별/팀별 데이터 분리**
- ✅ **SQL Injection 공격 시 피해 최소화**
- ✅ **관리자도 정책을 우회할 수 없음**

---

## 🚀 다음 단계: Day 4 SQL Injection 방지

RLS 정책이 성공적으로 적용되면, **Phase 1 Day 4: SQL Injection 방지**로 진행합니다.

### 준비할 작업:
1. **`ilike` 쿼리 안전화** (`lib/supabase-api.ts:112`)
2. **모든 동적 쿼리 파라미터 바인딩 적용**
3. **입력값 검증 강화**
4. **SQL Injection 테스트 실행**

---

**💡 팁**: RLS 정책 적용은 **한 번만 하면 되는 일회성 작업**이며, 적용 후에는 데이터베이스가 자동으로 보안을 유지합니다!